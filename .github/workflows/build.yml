name: Build
on:
  push:
    branches:
      - main
      - branch-*
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  sonarqube1:
    name: SonarQubeWindows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 1. Setup Node.js (necessario per npm)
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'
          
      # 2. Avviare il Database PostgreSQL con Docker Compose
      - name: Start Test Database
        # Questo comando viene eseguito dalla radice del progetto
        run: npm run db:test:start
        
      # 3. Attesa (molto importante!)
      - name: Wait for DB to be ready
        # Diamo al container PostgreSQL il tempo di avviarsi completamente
        run: sleep 10

      # 4. Installazione delle dipendenze e esecuzione dei test
      - name: Install dependencies and run tests
        run: |
          cd server
          npm ci
          npm run test
        
      # 5. Analisi SonarQube (sulla radice del progetto)
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602
        with:
          # Nessun projectBaseDir, analizza l'intera repository
          args: >
            -Dsonar.javascript.lcov.reportPaths=server/coverage/lcov.info
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          
      # 6. Pulizia: Spegni il Database (IMPORTANTE)
      - name: Stop Test Database
        # Devi indicare la stessa configurazione YAML per fermare il servizio.
        # Questo comando viene eseguito dalla radice del progetto.
        run: docker compose -f ./test/docker/postgres/docker-compose.yaml down
  sonarqube2:
    name: SonarQubeMac
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 1. Setup Node.js (necessario per npm)
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'
          
      # 2. Avviare il Database PostgreSQL con Docker Compose
      - name: Start Test Database
        # Questo comando viene eseguito dalla radice del progetto
        run: npm run db:test:start
        
      # 3. Attesa (molto importante!)
      - name: Wait for DB to be ready
        # Diamo al container PostgreSQL il tempo di avviarsi completamente
        run: sleep 10

      # 4. Installazione delle dipendenze e esecuzione dei test
      - name: Install dependencies and run tests
        run: |
          cd server
          npm ci
          npm run test
        
      # 5. Analisi SonarQube (sulla radice del progetto)
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602
        with:
          # Nessun projectBaseDir, analizza l'intera repository
          args: >
            -Dsonar.javascript.lcov.reportPaths=server/coverage/lcov.info
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          
      # 6. Pulizia: Spegni il Database (IMPORTANTE)
      - name: Stop Test Database
        # Devi indicare la stessa configurazione YAML per fermare il servizio.
        # Questo comando viene eseguito dalla radice del progetto.
        run: docker compose -f ./test/docker/postgres/docker-compose.yaml down
